name: TODO to GitHub Issues (PR only)

on:
  pull_request:
    branches: ["main"]

jobs:
  todo-from-pr:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout PR code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ” Extract new TODOs added in PR
        id: extract_todos
        run: |
          git fetch origin main
          git diff origin/main...HEAD --unified=0 | grep '^+.*TODO' > new_todos.txt || true
          git diff origin/main...HEAD --name-only > changed_files.txt
          
      - name: ğŸ·ï¸ Ensure "todo" label exists
        run: |
          gh label list | grep -q '^todo' || gh label create todo --description "Auto-created TODO item" --color FF8800

      - name: ğŸ§  Create one GitHub issue per new TODO
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          while IFS= read -r todo_line; do
            file=$(git diff origin/main...HEAD --unified=0 | grep -B5 "$todo_line" | grep '^+++ b/' | sed 's|+++ b/||')
            lineno=$(git diff origin/main...HEAD --unified=0 | grep -A5 "$todo_line" | grep '^@@' | sed -E 's/^@@ \+([0-9]+).*/\1/' | head -n1)
            lineno=${lineno:-1}

            todo=$(echo "$todo_line" | sed 's/^+//g' | xargs)
            url="${REPO_URL}/blob/${COMMIT_SHA}/${file}#L${lineno}"
            title="TODO in ${file} line ${lineno}"

            body="A new TODO was found in Pull Request #${PR_NUMBER}:\n\n"
            body+="ğŸ“„ **File**: \`${file}\`\n"
            body+="ğŸ”¢ **Line**: ${lineno}\n"
            body+="ğŸ”— [View in GitHub](${url})\n\n"
            body+="\`\`\`\n$todo\n\`\`\`\n\n"
            body+="ğŸ‘‰ Consider turning this into a properly tracked task."

            existing=$(gh issue list --state open --search "$title" --json title -q '.[].title')
            if [[ ! "$existing" =~ "$title" ]]; then
              gh issue create --title "$title" --body "$body" --label "todo"
            fi
          done < new_todos.txt
