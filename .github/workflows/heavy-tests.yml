name: heavy-tests

on:
    # Trigger manually
    workflow_dispatch:
        inputs:
            duration:
                description: 'Test duration in seconds'
                required: false
                default: '3600'
                type: string
    
    schedule:
        - cron: '0 2 * * 0' 

    push:
        branches: ['main']

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    heavy-property-tests:
        runs-on: ubuntu-latest
        timeout-minutes: 90  

        steps:
            - name: 📥 Checkout repository
              run: |
                  git clone ${{ github.server_url }}/${{ github.repository }} .
                  git fetch --all

            - name: 🔧 Install Rust
              run: |
                  curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain 1.85.0
                  echo "$HOME/.cargo/bin" >> $GITHUB_PATH

            - name: ⚙️ Build (release)
              run: |
                  source $HOME/.cargo/env
                  cargo build --release

            - name: 🐍 Setup Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12'

            - name: 🚀 Start server in background
              run: |
                  source $HOME/.cargo/env
                  cargo run --release &
                  # Wait for server to start
                  sleep 10
                  # Test if server is running
                  curl -f http://127.0.0.1:8080/ping || (echo "Server failed to start" && exit 1)

            - name: 🧪 Run Heavy Property-Based Tests
              run: |
                  cd tests
                  duration=${{ github.event.inputs.duration || '3600' }}
                  python propertybased.py --duration $duration
