name: Generate Release with Changelog

on:
  pull_request:
    types: [closed]

jobs:
  generate-release-changelog:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.base.ref, 'release/')
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Git
        run: |
          git fetch --prune --unshallow || true
          git fetch --tags

      - name: ðŸ§  Get merged PRs into release branch
        id: changelog
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseBranch = '${{ github.event.pull_request.base.ref }}';
            const headBranch = '${{ github.event.pull_request.head.ref }}';
            const mergedPr = context.payload.pull_request;

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              base: baseBranch,
              per_page: 100
            });

            const mergedPRs = pulls.filter(pr =>
              pr.merged_at &&
              pr.merge_commit_sha &&
              pr.merged_at <= mergedPr.merged_at
            );

            const features = [];
            const bugfixes = [];
            const others = [];

            for (const pr of mergedPRs) {
              const title = pr.title;
              const link = pr.html_url;
              const sourceBranch = pr.head.ref;

              const line = `- ${title} ([#${pr.number}](${link}))`;

              if (sourceBranch.startsWith('feature/')) {
                features.push(line);
              } else if (sourceBranch.startsWith('bug/')) {
                bugfixes.push(line);
              } else {
                others.push(line);
              }
            }

            let body = `## ðŸ“ Changelog\n\n`;

            if (features.length) {
              body += `### âœ¨ Features\n${features.join('\n')}\n\n`;
            }
            if (bugfixes.length) {
              body += `### ðŸ› Bugfixes\n${bugfixes.join('\n')}\n\n`;
            }
            if (others.length) {
              body += `### ðŸ”§ Autres\n${others.join('\n')}\n\n`;
            }

            body += `---\nRelease triggered by @${{ github.actor }}`;

            core.setOutput('changelog', body);

      - name: ðŸš€ Create or update release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ github.event.pull_request.base.ref }}
          name: 'Release ${{ github.event.pull_request.base.ref }}'
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
