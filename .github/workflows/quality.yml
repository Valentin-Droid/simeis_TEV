name: Rust Code Quality

on:
  pull_request:
    branches: ["**"]
  workflow_dispatch:

jobs:
  quality-check:
    runs-on: macos-latest

    steps:
      - name: üì• Clone du d√©p√¥t
        run: |
          git clone ${{ github.server_url }}/${{ github.repository }} .
          git fetch --all

      - name: Restore Rust cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock', '**/*.rs') }}

      - name: üõ†Ô∏è Installer Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain 1.87.0
          source $HOME/.cargo/env
          rustup component add rustfmt clippy
          cargo install cargo-audit

      - name: V√©rification version (rustfmt)
        run: |
          source $HOME/.cargo/env
          cargo fmt --version

      - name: V√©rification hash (rustfmt)
        run: |
          source $HOME/.cargo/env
          shasum simeis-server/src/api.rs

      - name: V√©rification formatage (rustfmt)
        run: |
          source $HOME/.cargo/env
          cargo fmt --check

      - name: üîç Linting (clippy)
        run: |
          source $HOME/.cargo/env
          cargo clippy

      - name: üõ°Ô∏è Audit de s√©curit√©
        run: |
          source $HOME/.cargo/env
          cargo audit
