name: diy-dependabot

on:
  schedule:
    - cron: "0 8 * * 1" # Tous les lundis Ã  08h00 UTC
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Rust
        run: |
          rustup update
          rustup component add rustfmt

      - name: ðŸ“¦ Install cargo-update
        run: cargo install cargo-update

      - name: ðŸ”„ Update dependencies
        run: cargo install-update -a

      - name: ðŸ“Š Check if dependencies changed
        run: |
          git config user.name "diy-bot"
          git config user.email "diy-bot@example.com"
          git add .
          git diff --cached --quiet || git commit -m "chore: update Rust dependencies"

      - name: ðŸš€ Create Pull Request
        if: success() # Ne sâ€™exÃ©cute que sâ€™il y a eu un commit
        run: |
          BRANCH="bot/update-deps-$(date +'%Y%m%d')"
          git checkout -b "$BRANCH"
          git push origin "$BRANCH"

          gh pr create --title "chore: update Rust dependencies" \
                       --body "Mise Ã  jour automatique des dÃ©pendances avec cargo-update" \
                       --label "bot/update" \
                       --head "$BRANCH" \
                       --base "main"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
