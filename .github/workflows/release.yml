name: Release Automation

on:
    pull_request:
        types: [closed]

jobs:
    build-release:
        if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.base.ref, 'release/')
        strategy:
            matrix:
                os: [ubuntu-latest]
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      suffix: linux-x64
                      extension: ''
        runs-on: ubuntu-latest
        outputs:
            git-hash: ${{ steps.git-info.outputs.git-hash }}
            git-message: ${{ steps.git-info.outputs.git-message }}
        steps:
            - name: üì• Checkout repository
              run: |
                  git clone ${{ github.server_url }}/${{ github.repository }} .
                  git fetch --all

            - name: ü¶Ä Setup Rust
              run: |
                  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
                  if [ "$RUNNER_OS" != "Windows" ]; then
                    source ~/.cargo/env
                  fi
                  rustup target add ${{ matrix.target }}
              shell: bash

            - name: üì¶ Prepare Rust environment
              run: |
                  # Pas de cache, on laisse Cargo g√©rer ses d√©pendances
              shell: bash

            - name: üîß Install Typst for documentation
              run: |
                  curl -fsSL https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJ
                  sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
              shell: bash

            - name: üèóÔ∏è Build release binary
              run: |
                  cargo build --release --target ${{ matrix.target }}
              shell: bash

            - name: üìã Set up Git info for release
              id: git-info
              run: |
                  gitHash=$(git rev-parse --short=8 HEAD)
                  gitMessage=$(git log -1 --pretty=%B)
                  echo "git-hash=$gitHash" >> "$GITHUB_OUTPUT"
                  echo "git-message<<EOF" >> "$GITHUB_OUTPUT"
                  echo "$gitMessage" >> "$GITHUB_OUTPUT"
                  echo "EOF" >> "$GITHUB_OUTPUT"
              shell: bash

            - name: üìñ Generate documentation
              run: |
                  typst compile doc/manual.typ doc/manual.pdf
              shell: bash

            - name: Prepare release artifacts
              run: |
                  mkdir release-artifacts
                  cp target/${{ matrix.target }}/release/simeis-server${{ matrix.extension }} release-artifacts/simeis-server-${{ matrix.suffix }}${{ matrix.extension }}
              shell: bash

            - name: üì¶ Prepare documentation
              run: |
                  mkdir -p release-artifacts
                  cp doc/manual.pdf release-artifacts/simeis-manual.pdf
                  tar -czf release-artifacts/simeis-source-${{ github.ref_name }}.tar.gz \
                    --exclude=target \
                    --exclude=.git \
                    --exclude=build \
                    .
              shell: bash

            - name: üì§ Store artifacts temporarily
              run: |
                  mkdir -p /tmp/shared-artifacts
                  cp -r release-artifacts/* /tmp/shared-artifacts/ || true
                  ls -la /tmp/shared-artifacts/
              shell: bash

    create_or_update_release:
        if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.base.ref, 'release/')
        needs: build-release
        runs-on: ubuntu-latest
        steps:
            - name: üì• Checkout repository
              run: |
                  git clone ${{ github.server_url }}/${{ github.repository }} .
                  git fetch --all

            - name: üì• Download all artifacts
              run: |
                  mkdir -p ./artifacts
                  cp -r /tmp/shared-artifacts/* ./artifacts/ || true
                  find ./artifacts -type f -ls

            - name: üì¶ Consolidate artifacts
              run: |
                  mkdir -p release-artifacts
                  find ./artifacts -name "simeis-server-*" -type f -exec cp {} release-artifacts/ \;
                  find ./artifacts -name "simeis-manual.pdf" -type f -exec cp {} release-artifacts/ \;
                  find ./artifacts -name "simeis-source-*.tar.gz" -type f -exec cp {} release-artifacts/ \;
                  ls -la release-artifacts/

            - name: üìù Generate changelog from merged PRs
              id: changelog
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Get the latest release tag (if any)
                  latest_tag=$(git tag --sort=-creatordate | grep '^release/' | head -n1)
                  if [ -z "$latest_tag" ]; then
                    base_sha=$(git rev-list --max-parents=0 HEAD)
                  else
                    base_sha=$(git rev-list -n 1 "$latest_tag")
                  fi
                  head_sha=$(git rev-parse HEAD)
                  # Get merged PRs between base_sha and head_sha
                  prs=$(gh pr list --state merged --search "base:$(echo ${{ github.event.pull_request.base.ref }})" --json number,title,headRefName,url,mergedAt --jq '.[] | select(.mergedAt != null) | select(.mergedAt >= ("$(git show -s --format=%cI $base_sha)"))')
                  # Classify PRs
                  features=""
                  bugfixes=""
                  others=""
                  while read -r pr; do
                    pr_number=$(echo "$pr" | jq -r '.number')
                    pr_title=$(echo "$pr" | jq -r '.title')
                    pr_head=$(echo "$pr" | jq -r '.headRefName')
                    pr_url=$(echo "$pr" | jq -r '.url')
                    if [[ "$pr_head" =~ ^feature/ ]]; then
                      features+="- [#$pr_number]($pr_url) $pr_title\n"
                    elif [[ "$pr_head" =~ ^bug/ ]]; then
                      bugfixes+="- [#$pr_number]($pr_url) $pr_title\n"
                    else
                      others+="- [#$pr_number]($pr_url) $pr_title\n"
                    fi
                  done < <(gh pr list --state merged --search "base:$(echo ${{ github.event.pull_request.base.ref }})" --json number,title,headRefName,url,mergedAt --jq '.[] | select(.mergedAt != null) | select(.mergedAt >= ("$(git show -s --format=%cI $base_sha)"))')
                  # Write changelog
                  echo "## ‚ú® Features" > changelog.md
                  if [ -n "$features" ]; then echo -e "$features" >> changelog.md; else echo "_Aucune_" >> changelog.md; fi
                  echo "\n## üêõ Bugfix" >> changelog.md
                  if [ -n "$bugfixes" ]; then echo -e "$bugfixes" >> changelog.md; else echo "_Aucun_" >> changelog.md; fi
                  echo "\n## üîÑ Autre" >> changelog.md
                  if [ -n "$others" ]; then echo -e "$others" >> changelog.md; else echo "_Aucun_" >> changelog.md; fi
                  # Export for next step
                  changelog_content=$(cat changelog.md)
                  changelog_content="${changelog_content//'%'/'%25'}"
                  changelog_content="${changelog_content//$'\n'/'%0A'}"
                  changelog_content="${changelog_content//$'\r'/'%0D'}"
                  echo "changelog=$changelog_content" >> "$GITHUB_OUTPUT"

            - name: Format release name
              id: format_release_name
              run: |
                  NAME="${{ github.event.pull_request.base.ref }}"
                  NAME_CLEANED="${NAME#release/}"
                  echo "name=Release $NAME_CLEANED" >> "$GITHUB_OUTPUT"
                  echo "name_cleaned=$NAME_CLEANED" >> "$GITHUB_OUTPUT"

            - name: Create or update GitHub Release
              uses: mini-bomba/create-github-release@v1.2.0
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  tag: ${{ steps.format_release_name.outputs.name_cleaned }}
                  name: ${{ steps.format_release_name.outputs.name }}
                  body: |
                      Release triggered by @${{ github.actor }}
                      Commit: ${{ needs.build-release.outputs.git-hash }}
                      Message:
                      ${{ needs.build-release.outputs.git-message }}

                      ### Changelog
                      ${{ steps.changelog.outputs.changelog }}

                      - `simeis-server-linux-x64` : Binaire principal optimis√© pour Linux x64
                      - `simeis-manual.pdf` : Documentation compl√®te du projet
                      - `simeis-source-${{ github.event.pull_request.base.ref }}.tar.gz` : Code source de la release

                      [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  files: |
                      release-artifacts/*
                  clear_attachments: true
