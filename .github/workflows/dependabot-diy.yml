name: DIY Dependabot

# DÃ©clenchement cyclique (tous les jours Ã  5h UTC)
on:
    schedule:
        - cron: '0 5 * * *'

    # Permet aussi de dÃ©clencher manuellement
    workflow_dispatch:

env:
    RUST_BACKTRACE: 1

jobs:
    update-dependencies:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout repository
              uses: actions/checkout@v4
              with:
                  # On a besoin d'un token avec les permissions pour crÃ©er des PRs
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: ğŸ”§ Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: ğŸ“¦ Install cargo-edit (pour cargo-update)
              run: cargo install cargo-edit

            - name: ğŸ” Check current dependencies
              run: |
                  echo "=== DÃ©pendances actuelles ==="
                  cargo tree --depth 1

            - name: ğŸ†™ Update dependencies
              id: update
              run: |
                  # Mettre Ã  jour les dÃ©pendances dans le workspace
                  echo "=== Mise Ã  jour des dÃ©pendances ==="

                  # Sauvegarder les Cargo.lock actuels
                  cp Cargo.lock Cargo.lock.backup || true

                  # Mettre Ã  jour toutes les dÃ©pendances
                  cargo update

                  # VÃ©rifier s'il y a des changements
                  if ! diff -q Cargo.lock.backup Cargo.lock > /dev/null 2>&1; then
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "Des dÃ©pendances ont Ã©tÃ© mises Ã  jour !"
                    
                    # Afficher les changements
                    echo "=== Changements dÃ©tectÃ©s ==="
                    diff Cargo.lock.backup Cargo.lock || true
                  else
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "Aucune mise Ã  jour de dÃ©pendance disponible."
                  fi

            - name: ğŸ§ª Test with updated dependencies
              if: steps.update.outputs.changes == 'true'
              run: |
                  echo "=== Test avec les nouvelles dÃ©pendances ==="
                  cargo test

            - name: ğŸ“‹ Generate update summary
              if: steps.update.outputs.changes == 'true'
              id: summary
              run: |
                  # CrÃ©er un rÃ©sumÃ© des changements
                  echo "GÃ©nÃ©ration du rÃ©sumÃ© des changements..."

                  # Comparer les versions
                  echo "## ğŸš€ Mise Ã  jour automatique des dÃ©pendances" > update-summary.md
                  echo "" >> update-summary.md
                  echo "Ce PR a Ã©tÃ© crÃ©Ã© automatiquement par le systÃ¨me DIY Dependabot." >> update-summary.md
                  echo "" >> update-summary.md
                  echo "### ğŸ“¦ Changements dans les dÃ©pendances:" >> update-summary.md
                  echo "" >> update-summary.md
                  echo "\`\`\`diff" >> update-summary.md
                  diff Cargo.lock.backup Cargo.lock | head -50 >> update-summary.md || true
                  echo "\`\`\`" >> update-summary.md
                  echo "" >> update-summary.md
                  echo "### âœ… Tests" >> update-summary.md
                  echo "- [x] Les tests passent avec les nouvelles dÃ©pendances" >> update-summary.md
                  echo "- [x] La compilation rÃ©ussit en mode release" >> update-summary.md
                  echo "" >> update-summary.md
                  echo "---" >> update-summary.md
                  echo "*GÃ©nÃ©rÃ© automatiquement le $(date)*" >> update-summary.md

            - name: ğŸ”€ Create Pull Request
              if: steps.update.outputs.changes == 'true'
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: 'ğŸ†™ Mise Ã  jour automatique des dÃ©pendances'
                  title: 'ğŸ¤– Mise Ã  jour automatique des dÃ©pendances'
                  body-path: update-summary.md
                  branch: bot/update-dependencies
                  labels: |
                      dependencies
                      bot/update
                  assignees: ${{ github.actor }}
                  draft: false
                  # Supprime la branche aprÃ¨s merge
                  delete-branch: true

            - name: ğŸ“Š Summary
              run: |
                  if [ "${{ steps.update.outputs.changes }}" == "true" ]; then
                    echo "âœ… Une PR de mise Ã  jour des dÃ©pendances a Ã©tÃ© crÃ©Ã©e !"
                  else
                    echo "â„¹ï¸ Aucune mise Ã  jour nÃ©cessaire."
                  fi
